<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EVYON OS | STABLE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: #000;
            height: 100dvh; width: 100vw; /* dvh para m칩viles */
            display: flex; justify-content: center; align-items: center;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            color: #fff;
            position: fixed; top: 0; left: 0;
        }

        /* FONDO LIMPIO */
        .bg-vignette {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111 0%, #000 90%);
            z-index: -5;
        }
        
        /* CANVAS */
        canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; 
            filter: contrast(1.2); 
        }

        /* HUD */
        .hud-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 5; 
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
        }
        
        .corner { position: absolute; width: 25px; height: 25px; border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.5s ease; }
        .hud-speaking .corner { border-color: #00ff9d; box-shadow: 0 0 10px rgba(0, 255, 157, 0.3); }
        .hud-error .corner { border-color: #ff3333; }
        
        .tl { top: 25px; left: 25px; border-right: none; border-bottom: none; }
        .tr { top: 25px; right: 25px; border-left: none; border-bottom: none; }
        .bl { bottom: 25px; left: 25px; border-right: none; border-top: none; }
        .br { bottom: 25px; right: 25px; border-left: none; border-top: none; }

        /* UI */
        #orb-interface {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 1s ease; z-index: 10;
            position: relative; width: 100%; height: 100%;
        }

        .interaction-zone {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            cursor: pointer; z-index: 20;
        }

        .status-text {
            position: absolute; bottom: 15%;
            font-size: 14px; letter-spacing: 6px; font-weight: 500;
            color: rgba(255, 255, 255, 0.3);
            text-transform: uppercase; pointer-events: none; transition: color 0.5s;
            text-align: center; width: 100%;
        }

        /* LOGIN */
        #login-screen {
            position: absolute; z-index: 20; text-align: center;
            background: #000; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding-bottom: 50px;
        }
        .login-input {
            background: transparent; border: 1px solid rgba(255,255,255,0.2); 
            padding: 12px; color: #fff; font-family: 'Rajdhani', sans-serif; font-size: 18px;
            text-align: center; letter-spacing: 5px; width: 240px; outline: none;
            text-transform: uppercase; margin-top: 25px; border-radius: 4px;
        }
        .login-input:focus { border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.1); }

    </style>
</head>
<body>
    <div class="bg-vignette"></div>
    <canvas id="glassCore"></canvas>
    <audio id="main-speaker" playsinline style="display:none;"></audio>

    <div class="hud-overlay" id="hud">
        <div class="corner tl"></div><div class="corner tr"></div>
        <div class="corner bl"></div><div class="corner br"></div>
    </div>

    <div id="login-screen">
        <h1 style="color:#fff; font-weight:300; letter-spacing:8px; font-size:26px;">EVYON <span style="color:#fff; font-weight:600; opacity:0.8;">OS</span></h1>
        <input type="password" id="password" class="login-input" placeholder="ACCESS" onkeydown="handleLoginKey(event)">
    </div>

    <div id="orb-interface">
        <div class="interaction-zone" onclick="toggleListening()"></div>
        <div class="status-text" id="statusLabel">READY</div>
    </div>

    <script>
        /* ================= CONFIGURACI칍N ================= */
        const INSTITUTION_DB = { "tec": { pass: "TEC2106", name: "Iv치n" }, "founder": { pass: "IVAN2106", name: "Sr. Iv치n" } };
        let apiKey = localStorage.getItem("evyon_api_key");
        let isListening = false;
        let isSpeaking = false;
        
        // COLORES DIAMOND
        const COL_EMERALD_HINT = { r: 0, g: 255, b: 157 };
        const COL_SILVER = { r: 240, g: 245, b: 255 }; 
        const COL_CYAN_HINT = { r: 0, g: 220, b: 255 };
        
        let targetGlowColor = COL_EMERALD_HINT;
        let targetGlowAlpha = 0.25;
        let currentGlowColor = { ...COL_EMERALD_HINT };
        let currentGlowAlpha = 0.25;

        let targetSpeed = 0.0015;
        let currentSpeed = 0.0015;
        let targetScale = 1.0;
        let currentScale = 1.0;
        let targetPulse = 0;
        let currentPulse = 0;
        
        let conversationHistory = [];
        const SILENT_MP3 = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////wAAADFMYXZjNTguMTM0AAAAAAAAAAAAAAAAJAAAAAAAAAAAASAAVrGHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//OECQAAAAAgAAAAAAALAAAAAAABAAABAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//OECQAAAAAAAAAAAAAAAAAAAAABAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//OECQAAAAAAAAAAAAAAAAAAAAABAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";

        /* ================= MOTOR 3D CORREGIDO (FIX DOBLE ZOOM) ================= */
        const canvas = document.getElementById('glassCore');
        const ctx = canvas.getContext('2d');
        let width, height, dpr;
        let particles = [];
        const numParticles = 380; 

        // 1. AJUSTE DE RESOLUCI칍N REAL
        function resize() {
            dpr = window.devicePixelRatio || 1;
            // Usamos el tama침o l칩gico de la ventana
            width = window.innerWidth;
            height = window.innerHeight;
            
            // Escalamos el canvas f칤sicamente, pero NO el contexto con ctx.scale()
            // Esto evita el conflicto de coordenadas. Haremos las matem치ticas con pixeles reales.
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            
            // Forzamos el tama침o CSS para que ocupe la pantalla
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
        }
        window.addEventListener('resize', resize);
        resize();

        // 2. GENERACI칍N DE PART칈CULAS
        for(let i=0; i<numParticles; i++) {
            const theta = Math.acos(-1 + (2 * i) / numParticles);
            const phi = Math.sqrt(numParticles * Math.PI) * theta;
            particles.push({ 
                x: Math.sin(theta) * Math.cos(phi), 
                y: Math.sin(theta) * Math.sin(phi), 
                z: Math.cos(theta),
                phase: Math.random() * Math.PI * 2
            });
        }

        function lerp(start, end, t) { return start * (1 - t) + end * t; }

        function drawFixedCore() {
            // Limpiar usando dimensiones reales
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // F칤sicas
            currentSpeed = lerp(currentSpeed, targetSpeed, 0.05);
            currentScale = lerp(currentScale, targetScale, 0.05);
            currentPulse = lerp(currentPulse, targetPulse, 0.1);
            
            // Color
            currentGlowColor.r = lerp(currentGlowColor.r, targetGlowColor.r, 0.05);
            currentGlowColor.g = lerp(currentGlowColor.g, targetGlowColor.g, 0.05);
            currentGlowColor.b = lerp(currentGlowColor.b, targetGlowColor.b, 0.05);
            currentGlowAlpha = lerp(currentGlowAlpha, targetGlowAlpha, 0.05);

            // 3. C츼LCULO DE CENTRO Y RADIO SEGURO
            const realWidth = canvas.width;
            const realHeight = canvas.height;
            const cx = realWidth / 2;
            const cy = realHeight / 2;
            
            // EL FIX: El radio es relativo al lado M츼S PEQUE칌O de la pantalla f칤sica
            // 35% del ancho/alto m칤nimo. Nunca se saldr치.
            const minDim = Math.min(realWidth, realHeight);
            const baseRadius = minDim * 0.35 * currentScale; 

            ctx.globalCompositeOperation = 'lighter'; 
            
            particles.forEach((p, i) => {
                // Rotaci칩n
                const rx = p.x * Math.cos(currentSpeed) - p.z * Math.sin(currentSpeed);
                const rz = p.x * Math.sin(currentSpeed) + p.z * Math.cos(currentSpeed);
                p.x = rx; p.z = rz;

                // 4. PROYECCI칍N CORREGIDA (Sin Clipping)
                // "Alejamos" la c치mara virtualmente (+2.5) para que nada golpee la pantalla
                const fov = 2.5; 
                const zScale = fov / (fov + p.z); 
                
                const x2d = cx + (p.x * baseRadius * zScale); 
                const y2d = cy + (p.y * baseRadius * zScale);

                // Efectos
                const vibe = (Math.random() - 0.5) * currentPulse * dpr; // Ajustado a retina
                
                // Tama침o seguro: M치ximo 3px base * dpr
                const dotSize = Math.max(0.5, (1.5 * zScale * dpr) + (currentPulse * 0.1));
                
                // Dibujado
                ctx.shadowBlur = 10 * dpr; 
                ctx.shadowColor = `rgba(${currentGlowColor.r}, ${currentGlowColor.g}, ${currentGlowColor.b}, ${currentGlowAlpha})`;
                ctx.fillStyle = `rgba(${COL_SILVER.r}, ${COL_SILVER.g}, ${COL_SILVER.b}, ${zScale * 0.4})`; 
                
                ctx.beginPath(); 
                ctx.arc(x2d + vibe, y2d + vibe, dotSize, 0, Math.PI * 2); 
                ctx.fill();
            });
            
            requestAnimationFrame(drawFixedCore);
        }
        drawFixedCore();

        /* ================= ESTADOS ================= */
        function setVisualState(state) {
            const label = document.getElementById("statusLabel");
            const hud = document.getElementById("hud");
            
            hud.className = "hud-overlay";

            if (state === 'idle') {
                targetGlowColor = COL_EMERALD_HINT; targetGlowAlpha = 0.25; 
                targetSpeed = 0.0015; targetPulse = 0; targetScale = 1.0;
                label.innerText = "ONLINE"; label.style.color = "rgba(255,255,255,0.3)";
            } 
            else if (state === 'listening') {
                targetGlowColor = COL_SILVER; targetGlowAlpha = 0.6;
                targetSpeed = 0.0005; targetPulse = 1; targetScale = 1.15; 
                label.innerText = "LISTENING"; label.style.color = "#fff";
                hud.classList.add("hud-listening");
            } 
            else if (state === 'processing') {
                targetGlowColor = COL_CYAN_HINT; targetGlowAlpha = 0.5;
                targetSpeed = 0.08; targetPulse = 0; targetScale = 0.9; 
                label.innerText = "PROCESSING"; label.style.color = "rgba(0, 220, 255, 0.7)";
            } 
            else if (state === 'speaking') {
                targetGlowColor = COL_EMERALD_HINT; targetGlowAlpha = 0.5;
                targetSpeed = 0.004; targetPulse = 6; targetScale = 1.05; 
                label.innerText = "EVYON OS"; label.style.color = "#00ff9d";
                hud.classList.add("hud-speaking");
            }
            else if (state === 'error') {
                targetGlowColor = { r: 255, g: 50, b: 50 }; targetGlowAlpha = 0.8;
                label.innerText = "OFFLINE"; label.style.color = "#ff3333";
                hud.classList.add("hud-error");
            }
        }

        /* ================= SISTEMA ================= */
        function handleLoginKey(e) {
            if (e.key === "Enter") {
                const userKey = Object.keys(INSTITUTION_DB).find(key => INSTITUTION_DB[key].pass === e.target.value);
                if (userKey) {
                    checkApiKey();
                    document.getElementById("password").blur(); // Cierra teclado
                    document.getElementById("login-screen").style.transition = "opacity 0.8s";
                    document.getElementById("login-screen").style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById("login-screen").style.display = "none";
                        document.getElementById("orb-interface").style.display = "flex";
                        setTimeout(() => document.getElementById("orb-interface").style.opacity = 1, 500);
                        unlockAudio(); 
                    }, 800);
                }
            }
        }

        function checkApiKey() {
            if (!apiKey) {
                apiKey = prompt("游댐 API KEY:");
                if (apiKey) localStorage.setItem("evyon_api_key", apiKey);
            }
        }

        /* ================= AUDIO & VOZ ================= */
        const speaker = document.getElementById("main-speaker");

        function unlockAudio() {
            speaker.src = SILENT_MP3;
            speaker.play().catch(e => console.log("Audio waiting..."));
        }

        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return null;
            const rec = new SpeechRecognition();
            rec.lang = 'es-MX'; rec.interimResults = false;
            
            rec.onstart = () => { isListening = true; setVisualState('listening'); };
            
            rec.onend = () => { 
                isListening = false; 
                if (!isSpeaking && document.getElementById("statusLabel").innerText !== "PROCESSING") {
                    setVisualState('idle');
                }
            };
            
            rec.onresult = async (e) => { await processAI(e.results[0][0].transcript); };
            return rec;
        }

        const recognitionEngine = initVoice();

        function toggleListening() {
            unlockAudio();
            if (isSpeaking) return;
            if (isListening) recognitionEngine.stop();
            else recognitionEngine.start();
        }

        async function processAI(text) {
            setVisualState('processing');
            isSpeaking = true; 
            
            let sysPrompt = "Eres EVYON. Voz fluida, natural. Respuestas concisas.";
            if (text.match(/flojera|cansad|sue침o/i)) sysPrompt = "Eres LE칍NIDAS. Energ칤a alta.";

            try {
                const res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "gpt-4o", messages: [{ role: "system", content: sysPrompt }, ...conversationHistory, { role: "user", content: text }], max_tokens: 150 })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);
                
                const reply = data.choices[0].message.content;
                conversationHistory.push({ role: "user", content: text }, { role: "assistant", content: reply });
                
                await playAudio(reply);

            } catch (err) {
                console.error(err);
                setVisualState('error');
                setTimeout(() => { isSpeaking = false; setVisualState('idle'); }, 2000);
            }
        }

        async function playAudio(text) {
            setVisualState('speaking'); 
            try {
                const res = await fetch("https://api.openai.com/v1/audio/speech", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "tts-1", voice: "nova", input: text })
                });
                const blob = await res.blob();
                speaker.src = URL.createObjectURL(blob);
                speaker.onended = () => { isSpeaking = false; setVisualState('idle'); };
                await speaker.play();
            } catch (err) {
                console.error(err);
                isSpeaking = false;
                setVisualState('idle'); 
            }
        }
    </script>
</body>
</html>
