<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EVYON V7 | ULTRON CORE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: #000;
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            color: #fff;
        }

        /* --- FONDO TECH --- */
        .bg-vignette {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a2332 0%, #000 90%);
            z-index: -5;
        }
        
        /* --- CANVAS 3D (EL CEREBRO) --- */
        canvas {
            position: absolute; top: 0; left: 0; z-index: 1;
        }

        /* --- HUD (HUD DE IRON MAN) --- */
        .hud-overlay {
            position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 5;
            padding: 20px;
        }
        .corner {
            position: absolute; width: 50px; height: 50px;
            border: 2px solid #3cd186; opacity: 0.5;
        }
        .tl { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .tr { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .bl { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .br { bottom: 20px; right: 20px; border-left: none; border-top: none; }

        /* --- UI CENTRAL --- */
        #orb-interface {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 1s ease; z-index: 10;
            position: relative;
        }

        /* El botón central invisible que captura el click */
        .interaction-zone {
            width: 250px; height: 250px;
            border-radius: 50%;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer; z-index: 20;
            /* Debug border: border: 1px solid red; */
        }

        .status-text {
            font-size: 24px; letter-spacing: 5px; font-weight: 700;
            color: #3cd186; text-shadow: 0 0 10px #3cd186;
            margin-top: 320px; /* Debajo de la esfera */
            text-transform: uppercase;
        }

        #voice-transcript {
            margin-top: 10px; font-size: 16px; color: rgba(255,255,255,0.7);
            text-align: center; max-width: 300px;
        }

        #error-log {
            position: absolute; bottom: 80px; color: #ef4444; font-size: 12px;
            text-shadow: 0 0 5px #ef4444; text-align: center; width: 100%;
        }

        /* --- LOGIN --- */
        #login-screen {
            position: absolute; z-index: 20; text-align: center;
            background: rgba(0,0,0,0.8); width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
        }
        .login-input {
            background: transparent; border: 1px solid #3cd186; padding: 15px;
            color: #3cd186; font-family: 'Rajdhani', sans-serif; font-size: 20px;
            text-align: center; letter-spacing: 5px; width: 300px; outline: none;
            box-shadow: 0 0 20px rgba(60,209,134,0.2);
            text-transform: uppercase;
        }

        /* --- ANIMACIONES DE ESTADO --- */
        /* Listening: El canvas se acelera (controlado por JS) y cambia color */
        /* Processing: Azul */
        /* Speaking: Dorado y vibra */

    </style>
</head>
<body>
    <div class="bg-vignette"></div>
    
    <canvas id="neuralCanvas"></canvas>

    <div class="hud-overlay">
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
    </div>

    <div id="login-screen">
        <h1 style="color:#fff; font-weight:300; letter-spacing:10px; font-size:40px;">EVYON <b style="color:#3cd186">V7</b></h1>
        <input type="password" id="password" class="login-input" placeholder="ACCESS CODE" onkeydown="handleLoginKey(event)">
        <div style="margin-top:20px; font-size:12px; color:#666;">SECURE NEURAL LINK</div>
    </div>

    <div id="orb-interface">
        <div class="interaction-zone" onclick="toggleListening()"></div>
        <div class="status-text" id="statusLabel">SYSTEM ONLINE</div>
        <div id="voice-transcript">Touch core to initialize</div>
        <div id="error-log"></div>
    </div>

    <script>
        /* =========================================
           1. CONFIGURACIÓN & SISTEMA
           ========================================= */
        const INSTITUTION_DB = {
            "tec": { pass: "TEC2106", name: "Iván" },
            "founder": { pass: "IVAN2106", name: "Sr. Iván" }
        };

        let apiKey = localStorage.getItem("evyon_api_key");
        let currentUser = null;
        let isListening = false;
        let sphereColor = { r: 60, g: 209, b: 134 }; // Verde Base
        let rotationSpeed = 0.005;
        let pulseIntensity = 0;

        // Memoria del Chat
        let conversationHistory = [];

        /* =========================================
           2. MOTOR GRÁFICO 3D (CANVAS PARTICLES)
           ========================================= */
        const canvas = document.getElementById('neuralCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        const numParticles = 250; // Cantidad de nodos

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Crear partículas en una esfera 3D
        for(let i=0; i<numParticles; i++) {
            const theta = Math.acos(-1 + (2 * i) / numParticles);
            const phi = Math.sqrt(numParticles * Math.PI) * theta;
            particles.push({
                x: 150 * Math.sin(theta) * Math.cos(phi), // Radio 150
                y: 150 * Math.sin(theta) * Math.sin(phi),
                z: 150 * Math.cos(theta),
                origX: 150 * Math.sin(theta) * Math.cos(phi),
                origY: 150 * Math.sin(theta) * Math.sin(phi),
                origZ: 150 * Math.cos(theta)
            });
        }

        function drawSphere() {
            ctx.clearRect(0, 0, width, height);
            
            // Centrar
            const cx = width / 2;
            const cy = height / 2;

            // Dibujar conexiones (Neural Lines)
            ctx.beginPath();
            ctx.strokeStyle = `rgba(${sphereColor.r}, ${sphereColor.g}, ${sphereColor.b}, 0.15)`;
            
            particles.forEach((p, i) => {
                // Rotación 3D Manual
                const rotX = p.x * Math.cos(rotationSpeed * 5) - p.z * Math.sin(rotationSpeed * 5);
                const rotZ = p.x * Math.sin(rotationSpeed * 5) + p.z * Math.cos(rotationSpeed * 5);
                p.x = rotX; p.z = rotZ; // Actualizar posición

                // Escala de perspectiva
                const scale = 300 / (300 + p.z); 
                const projX = cx + p.x * scale;
                const projY = cy + p.y * scale;

                // Vibración al hablar
                const vibe = (Math.random() - 0.5) * pulseIntensity;

                // Dibujar nodo
                const size = 2 * scale;
                ctx.fillStyle = `rgba(${sphereColor.r}, ${sphereColor.g}, ${sphereColor.b}, ${scale})`;
                ctx.fillRect(projX + vibe, projY + vibe, size, size);

                // Conectar con vecinos cercanos
                particles.forEach((p2, j) => {
                    if (i !== j) {
                        const dist = Math.sqrt((p.x-p2.x)**2 + (p.y-p2.y)**2 + (p.z-p2.z)**2);
                        if (dist < 40) {
                            const scale2 = 300 / (300 + p2.z);
                            ctx.moveTo(projX + vibe, projY + vibe);
                            ctx.lineTo(cx + p2.x * scale2 + vibe, cy + p2.y * scale2 + vibe);
                        }
                    }
                });
            });
            ctx.stroke();
            requestAnimationFrame(drawSphere);
        }
        drawSphere();

        /* =========================================
           3. LÓGICA DE ESTADOS & COLORES
           ========================================= */
        function setState(state) {
            const label = document.getElementById("statusLabel");
            const log = document.getElementById("voice-transcript");

            if (state === 'idle') {
                sphereColor = { r: 60, g: 209, b: 134 }; // Verde
                rotationSpeed = 0.002;
                pulseIntensity = 0;
                label.innerText = "SYSTEM ONLINE";
                label.style.color = "#3cd186";
            }
            else if (state === 'listening') {
                sphereColor = { r: 255, g: 255, b: 255 }; // Blanco Intenso
                rotationSpeed = 0.001; // Se detiene un poco para "escuchar"
                pulseIntensity = 2; // Ligera vibración
                label.innerText = "LISTENING...";
                label.style.color = "#fff";
            }
            else if (state === 'processing') {
                sphereColor = { r: 34, g: 211, b: 238 }; // Azul Cyan (Jarvis)
                rotationSpeed = 0.05; // Giro MUY rápido
                pulseIntensity = 0;
                label.innerText = "PROCESSING...";
                label.style.color = "#22d3ee";
            }
            else if (state === 'speaking') {
                sphereColor = { r: 250, g: 204, b: 21 }; // Dorado (Ultron/Voz)
                rotationSpeed = 0.005;
                pulseIntensity = 5; // Vibración fuerte por voz
                label.innerText = "EVYON VOICE";
                label.style.color = "#facc15";
            }
        }

        /* =========================================
           4. LOGIN
           ========================================= */
        function handleLoginKey(e) {
            if (e.key === "Enter") {
                const userKey = Object.keys(INSTITUTION_DB).find(key => INSTITUTION_DB[key].pass === e.target.value);
                if (userKey) {
                    currentUser = INSTITUTION_DB[userKey];
                    checkApiKey();
                    document.getElementById("login-screen").style.display = "none";
                    document.getElementById("orb-interface").style.display = "flex";
                    setTimeout(() => document.getElementById("orb-interface").style.opacity = 1, 100);
                }
            }
        }

        function checkApiKey() {
            if (!apiKey) {
                apiKey = prompt("⚠️ API KEY (sk-...):");
                if (apiKey) localStorage.setItem("evyon_api_key", apiKey);
            }
        }

        /* =========================================
           5. AUDIO & VOZ (FIXED)
           ========================================= */
        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'es-MX';
            recognition.interimResults = false;

            recognition.onstart = () => { isListening = true; setState('listening'); };
            recognition.onend = () => { 
                isListening = false; 
                // Si no pasó a processing, volver a idle
                if (document.getElementById("statusLabel").innerText !== "PROCESSING...") setState('idle'); 
            };
            
            recognition.onresult = async (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById("voice-transcript").innerText = `"${text}"`;
                await processAI(text);
            };

            return recognition;
        }

        const recognitionEngine = initVoice();

        function toggleListening() {
            if (!recognitionEngine) {
                alert("Navegador no soporta voz. Usa Chrome.");
                return;
            }
            if (isListening) recognitionEngine.stop();
            else recognitionEngine.start();
        }

        async function processAI(text) {
            setState('processing');
            
            // PERSONALIDAD V5.1 INTEGRADA
            let sysPrompt = "Eres EVYON, asistente táctico de alto rendimiento. Respuestas cortas y precisas.";
            if (text.match(/flojera|cansad|sueño/i)) sysPrompt = "Eres LEÓNIDAS. Grita y ordena entrenar. Sé agresivo.";
            if (text.match(/dolor|lesi|herid/i)) sysPrompt = "Eres Dr. EVYON. Sé clínico y protector.";

            const messages = [{ role: "system", content: sysPrompt }, ...conversationHistory, { role: "user", content: text }];

            try {
                const res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "gpt-4o", messages: messages, max_tokens: 100 })
                });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error.message);
                
                const reply = data.choices[0].message.content;
                conversationHistory.push({ role: "user", content: text }, { role: "assistant", content: reply });
                
                document.getElementById("voice-transcript").innerText = reply;
                await playAudio(reply);

            } catch (err) {
                document.getElementById("error-log").innerText = "ERROR NEURAL: " + err.message;
                setState('idle');
            }
        }

        async function playAudio(text) {
            setState('speaking');
            try {
                const res = await fetch("https://api.openai.com/v1/audio/speech", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "tts-1", voice: "onyx", input: text })
                });

                if (!res.ok) throw new Error("Error API Audio");

                const blob = await res.blob();
                const audioUrl = URL.createObjectURL(blob);
                const audio = new Audio(audioUrl);
                
                audio.onended = () => setState('idle');
                await audio.play();

            } catch (err) {
                document.getElementById("error-log").innerText = "FALLO DE AUDIO. Revisa API Key/Volumen.";
                setState('idle');
            }
        }

    </script>
</body>
</html>
