<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EVYON V7.1 | GLASS CORE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: #000;
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            color: #fff;
        }

        /* --- FONDO TECH DEEP --- */
        .bg-vignette {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #0f1520 0%, #000 80%);
            z-index: -5;
        }
        
        /* --- CANVAS 3D (CEREBRO DE CRISTAL) --- */
        canvas {
            position: absolute; top: 0; left: 0; z-index: 1;
            /* Filtro sutil para suavizar los p칤xeles y dar toque de lente */
            filter: blur(0.5px) contrast(1.2); 
        }

        /* --- HUD (BORDES T츼CTICOS) --- */
        .hud-overlay {
            position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 5;
            padding: 20px;
        }
        .corner {
            position: absolute; width: 40px; height: 40px;
            border: 2px solid rgba(60, 209, 134, 0.3); opacity: 0.6;
            transition: all 0.5s ease;
        }
        /* Al hablar, las esquinas brillar치n */
        .speaking .corner { border-color: #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.5); }
        
        .tl { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .tr { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .bl { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .br { bottom: 20px; right: 20px; border-left: none; border-top: none; }

        /* --- UI CENTRAL --- */
        #orb-interface {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 1s ease; z-index: 10;
            position: relative; width: 100%; height: 100%;
        }

        /* Zona de interacci칩n invisible (Toda la pantalla central) */
        .interaction-zone {
            width: 300px; height: 300px;
            border-radius: 50%;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer; z-index: 20;
            /* background: rgba(255,0,0,0.1); /* Debug para ver donde cliquear */
        }

        /* Texto de estado limpio */
        .status-text {
            position: absolute; bottom: 15%;
            font-size: 18px; letter-spacing: 8px; font-weight: 600;
            color: rgba(60, 209, 134, 0.8);
            text-shadow: 0 0 10px rgba(60, 209, 134, 0.5);
            text-transform: uppercase;
            pointer-events: none;
            transition: color 0.3s;
        }

        /* Login Screen Minimalista */
        #login-screen {
            position: absolute; z-index: 20; text-align: center;
            background: rgba(0,0,0,0.9); width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-input {
            background: transparent; border: 1px solid rgba(60, 209, 134, 0.5); 
            padding: 15px; color: #fff; font-family: 'Rajdhani', sans-serif; font-size: 24px;
            text-align: center; letter-spacing: 8px; width: 280px; outline: none;
            box-shadow: 0 0 30px rgba(60,209,134,0.1);
            text-transform: uppercase; margin-top: 20px;
            border-radius: 4px;
        }
        .login-input:focus { border-color: #3cd186; box-shadow: 0 0 50px rgba(60,209,134,0.3); }

    </style>
</head>
<body>
    <div class="bg-vignette"></div>
    
    <canvas id="glassCore"></canvas>

    <div class="hud-overlay" id="hud">
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
    </div>

    <div id="login-screen">
        <h1 style="color:#fff; font-weight:300; letter-spacing:12px; font-size:32px; opacity:0.9;">EVYON <span style="color:#3cd186; font-weight:700;">V7</span></h1>
        <input type="password" id="password" class="login-input" placeholder="CODE" onkeydown="handleLoginKey(event)">
    </div>

    <div id="orb-interface">
        <div class="interaction-zone" onclick="toggleListening()"></div>
        <div class="status-text" id="statusLabel">SYSTEM ONLINE</div>
    </div>

    <script>
        /* ================= CONFIGURACI칍N ================= */
        const INSTITUTION_DB = {
            "tec": { pass: "TEC2106", name: "Iv치n" },
            "founder": { pass: "IVAN2106", name: "Sr. Iv치n" }
        };

        let apiKey = localStorage.getItem("evyon_api_key");
        let currentUser = null;
        let isListening = false;
        
        // Colores Base (RGB)
        let targetColor = { r: 60, g: 209, b: 134 }; // Verde Evyon
        let currentColor = { r: 60, g: 209, b: 134 }; // Color actual (para transiciones suaves)
        
        // Din치micas de la esfera
        let rotationSpeed = 0.003;
        let pulseIntensity = 0;
        let particleSizeBase = 1.5;
        
        // Memoria Neural
        let conversationHistory = [];

        /* ================= MOTOR 3D "GLASS CORE" ================= */
        const canvas = document.getElementById('glassCore');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        const numParticles = 300; // Alta densidad

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Inicializar Part칤culas en Esfera
        for(let i=0; i<numParticles; i++) {
            const theta = Math.acos(-1 + (2 * i) / numParticles);
            const phi = Math.sqrt(numParticles * Math.PI) * theta;
            particles.push({
                x: 180 * Math.sin(theta) * Math.cos(phi),
                y: 180 * Math.sin(theta) * Math.sin(phi),
                z: 180 * Math.cos(theta)
            });
        }

        // Funci칩n de interpolaci칩n de color (Lerp)
        function lerp(start, end, t) { return start * (1 - t) + end * t; }

        function drawGlassCore() {
            // Efecto de barrido suave (Trail effect)
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // Deja una estela sutil
            ctx.fillRect(0, 0, width, height);
            
            // Suavizar transici칩n de color
            currentColor.r = lerp(currentColor.r, targetColor.r, 0.05);
            currentColor.g = lerp(currentColor.g, targetColor.g, 0.05);
            currentColor.b = lerp(currentColor.b, targetColor.b, 0.05);

            const cx = width / 2;
            const cy = height / 2;
            
            // Configuraci칩n de "Luz de Cristal"
            ctx.globalCompositeOperation = 'lighter'; // Mezcla aditiva (clave para el brillo)
            
            particles.forEach((p, i) => {
                // Rotaci칩n 3D
                const rx = p.x * Math.cos(rotationSpeed) - p.z * Math.sin(rotationSpeed);
                const rz = p.x * Math.sin(rotationSpeed) + p.z * Math.cos(rotationSpeed);
                p.x = rx; p.z = rz;

                const scale = 350 / (350 + p.z); // Perspectiva
                const x2d = cx + p.x * scale;
                const y2d = cy + p.y * scale;

                // Vibraci칩n Audio-Reactiva
                const vibeX = (Math.random() - 0.5) * pulseIntensity;
                const vibeY = (Math.random() - 0.5) * pulseIntensity;

                // Dibujar Nodo (Efecto Glow)
                const size = (particleSizeBase * scale) + (pulseIntensity * 0.2);
                
                // El brillo exterior (Halo)
                ctx.shadowBlur = 15; 
                ctx.shadowColor = `rgba(${currentColor.r}, ${currentColor.g}, ${currentColor.b}, 0.8)`;
                
                // El n칰cleo del nodo
                ctx.fillStyle = `rgba(${currentColor.r}, ${currentColor.g}, ${currentColor.b}, ${scale})`;
                
                ctx.beginPath();
                ctx.arc(x2d + vibeX, y2d + vibeY, size, 0, Math.PI * 2);
                ctx.fill();

                // Conexiones neuronales (L칤neas sutiles)
                // Solo conectamos nodos muy cercanos para no ensuciar el dise침o
                particles.forEach((p2, j) => {
                    if (i !== j) {
                        const dx = p.x - p2.x;
                        const dy = p.y - p2.y;
                        const dz = p.z - p2.z;
                        const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                        
                        if (dist < 35) {
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(${currentColor.r}, ${currentColor.g}, ${currentColor.b}, ${0.15 * scale})`;
                            ctx.lineWidth = 0.5 * scale;
                            ctx.moveTo(x2d + vibeX, y2d + vibeY);
                            
                            const scale2 = 350 / (350 + p2.z);
                            const x2d2 = cx + p2.x * scale2;
                            const y2d2 = cy + p2.y * scale2;
                            
                            ctx.lineTo(x2d2 + vibeX, y2d2 + vibeY);
                            ctx.stroke();
                        }
                    }
                });
            });
            
            // Restaurar modo de fusi칩n para el siguiente frame
            ctx.globalCompositeOperation = 'source-over';
            requestAnimationFrame(drawGlassCore);
        }
        drawGlassCore();

        /* ================= L칍GICA DE ESTADO ================= */
        function updateStateVisuals(state) {
            const label = document.getElementById("statusLabel");
            const hud = document.getElementById("hud");
            
            hud.className = "hud-overlay"; // Reset HUD

            if (state === 'idle') {
                targetColor = { r: 60, g: 209, b: 134 }; // Verde Original
                rotationSpeed = 0.003;
                pulseIntensity = 0;
                label.innerText = "SYSTEM ONLINE";
                label.style.color = "#3cd186";
            }
            else if (state === 'listening') {
                targetColor = { r: 255, g: 255, b: 255 }; // Blanco Puro
                rotationSpeed = 0.001; // Lento (Atenci칩n)
                pulseIntensity = 2; // Ligero temblor
                label.innerText = "LISTENING";
                label.style.color = "#fff";
            }
            else if (state === 'processing') {
                targetColor = { r: 34, g: 211, b: 238 }; // Cyan Neural
                rotationSpeed = 0.08; // Giro muy r치pido
                pulseIntensity = 0;
                label.innerText = "PROCESSING";
                label.style.color = "#22d3ee";
            }
            else if (state === 'speaking') {
                targetColor = { r: 250, g: 204, b: 21 }; // Dorado Voz
                rotationSpeed = 0.005;
                pulseIntensity = 6; // Vibraci칩n fuerte
                label.innerText = "EVYON VOICE";
                label.style.color = "#facc15";
                hud.classList.add("speaking"); // Activar brillo en esquinas
            }
        }

        /* ================= LOGIN ================= */
        function handleLoginKey(e) {
            if (e.key === "Enter") {
                const userKey = Object.keys(INSTITUTION_DB).find(key => INSTITUTION_DB[key].pass === e.target.value);
                if (userKey) {
                    currentUser = INSTITUTION_DB[userKey];
                    checkApiKey();
                    const login = document.getElementById("login-screen");
                    login.style.transition = "opacity 0.8s";
                    login.style.opacity = 0;
                    setTimeout(() => {
                        login.style.display = "none";
                        const ui = document.getElementById("orb-interface");
                        ui.style.display = "flex";
                        setTimeout(() => ui.style.opacity = 1, 100);
                    }, 800);
                }
            }
        }

        function checkApiKey() {
            if (!apiKey) {
                apiKey = prompt("游댐 API KEY:");
                if (apiKey) localStorage.setItem("evyon_api_key", apiKey);
            }
        }

        /* ================= AUDIO & IA ================= */
        function initVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return null;
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'es-MX';
            recognition.interimResults = false;

            recognition.onstart = () => { isListening = true; updateStateVisuals('listening'); };
            recognition.onend = () => { 
                isListening = false;
                // Solo volver a idle si no estamos procesando
                if (document.getElementById("statusLabel").innerText !== "PROCESSING") updateStateVisuals('idle'); 
            };
            
            recognition.onresult = async (e) => {
                const text = e.results[0][0].transcript;
                // Ya no mostramos transcripci칩n en pantalla
                await processAI(text);
            };

            return recognition;
        }

        const recognitionEngine = initVoice();

        function toggleListening() {
            if (!recognitionEngine) return;
            if (isListening) recognitionEngine.stop();
            else recognitionEngine.start();
        }

        async function processAI(text) {
            updateStateVisuals('processing');
            
            // Prompt Din치mico V5.1
            let sysPrompt = "Eres EVYON. Respuestas cortas, habladas y 칰tiles. Tono profesional.";
            if (text.match(/flojera|cansad|sue침o/i)) sysPrompt = "Eres LE칍NIDAS. Grita y ordena entrenar. S칠 agresivo.";
            if (text.match(/dolor|lesi|herid/i)) sysPrompt = "Eres Dr. EVYON. S칠 cl칤nico y protector.";

            const messages = [{ role: "system", content: sysPrompt }, ...conversationHistory, { role: "user", content: text }];

            try {
                const res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "gpt-4o", messages: messages, max_tokens: 120 })
                });
                const data = await res.json();
                if (data.error) throw new Error("API Error");
                
                const reply = data.choices[0].message.content;
                conversationHistory.push({ role: "user", content: text }, { role: "assistant", content: reply });
                
                await playAudio(reply);

            } catch (err) {
                console.error(err); // Solo log en consola, no en pantalla
                updateStateVisuals('idle');
            }
        }

        async function playAudio(text) {
            updateStateVisuals('speaking');
            try {
                const res = await fetch("https://api.openai.com/v1/audio/speech", {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: "tts-1", voice: "onyx", input: text })
                });

                const blob = await res.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                
                audio.onended = () => updateStateVisuals('idle');
                
                // Intentar reproducir (sin reporte visual de errores menores)
                try {
                    await audio.play();
                } catch (playErr) {
                    console.warn("Autoplay bloqueado o interrumpido:", playErr);
                    // No cambiamos el estado visual a error, dejamos que el usuario intente de nuevo
                }

            } catch (err) {
                console.error("Error Fetch Audio:", err);
                updateStateVisuals('idle');
            }
        }
    </script>
</body>
</html>
